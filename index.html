
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>My</title>
    <H3>ë‚˜ì˜ ì›¹(0317137263, ê¹€ê·œí˜¸)</H3>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const brokerUrl = 'wss://damoa.io:9002';
    
        // ê³ ìœ í•œ í´ë¼ì´ì–¸íŠ¸ ID ìƒì„± (ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ì¶©ëŒ ë°©ì§€)
        const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);
        
        // ë³„ë„ ì¸ì¦ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ options ê°ì²´ëŠ” ê°„ë‹¨í•˜ê²Œ clientIdë§Œ í¬í•¨
        const options = {
          clientId: clientId,
        };
    
        console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl})ì— ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
        const client = mqtt.connect(brokerUrl, options);
    
        // 1. ë¸Œë¡œì»¤ ì ‘ì† ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
        client.on('connect', () => {
            console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);
    
            // 2. ì ‘ì† ì„±ê³µ í›„ í† í”½ êµ¬ë…
            const topic = `ewha/0317137263`; // ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ê³ ìœ í•œ í† í”½ ì‚¬ìš©, ë³¸ì¸í•™ë²ˆìœ¼ë¡œ ìˆ˜ì •
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log(`ğŸ“„ í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`);
    
                    // 3. êµ¬ë… ì„±ê³µ í›„ í•´ë‹¹ í† í”½ìœ¼ë¡œ ë©”ì‹œì§€ ë°œí–‰
                    //const message = 'Hello, MQTT from browser!';
                    //console.log(`ğŸš€ ë©”ì‹œì§€ ë°œí–‰: "${message}"`);
                    //client.publish(topic, message);
                    client.publish('ewha/checkin', "ë³¸ì¸í•™ë²ˆ ì´ë¦„");
                } else {
                    console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
                }
            });
        });
    
        // 4. êµ¬ë…í•œ í† í”½ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë“¤ì–´ì™”ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
        client.on('message', (topic, message) => {
            console.log(`${topic} ${message.toString()}`);
            // 1. idê°€ 'main'ì¸ div ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const mainDiv = document.getElementById('main');
    
            // 2. ìƒˆë¡œ ì¶”ê°€í•  HTML ì½”ë“œë¥¼ ë¬¸ìì—´ë¡œ ë§Œë“­ë‹ˆë‹¤. (ë°±í‹± `` ì‚¬ìš©)
            const messageHTML = `
                <div class="message-item">
                    <span>${message.toString()}</span>
                </div>
            `;
    
            // 3. ìƒˆë¡œìš´ HTMLì„ ì ìš© í•©ë‹ˆë‹¤.
            mainDiv.innerHTML = messageHTML;
            
            // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ì•„ë˜ë¡œ ì´ë™ì‹œì¼œ ìµœì‹  ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            mainDiv.scrollTop = mainDiv.scrollHeight;
    
            // ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ì ‘ì† ì¢…ë£Œ
            //client.end();
            //console.log('ğŸ”š ì‘ì—… ì™„ë£Œ í›„ ì ‘ì†ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
        });
        
        // ì ‘ì† ì¤‘ ì—ëŸ¬ ë°œìƒ ì‹œ
        client.on('error', (err) => {
            console.error('ì—°ê²° ì˜¤ë¥˜:', err);
            client.end();
        });
    </script>
</head>
    
<body>
<div id="main"></div>
</body>
</html>
