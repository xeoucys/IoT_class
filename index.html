<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>MQTT ì˜ˆì œ</title>
    <h3>ë‚˜ì˜ ì›¹ (2566023, ì„œìœ ì •)</h3>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        // ===== ê¸°ë³¸ ì„¤ì • =====
        const brokerUrl = 'wss://damoa.io/mqtt'; // ì›¹ì†Œì¼“ìš© ì£¼ì†Œ (1883ì€ ì›¹ì—ì„œ ë¶ˆê°€)
        const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);
        const options = { clientId: clientId };

        const pubTopic = 'ewha/exam/2566023';      // ë°œí–‰ í† í”½
        const subTopic = 'ewha/exam/ans/2566023';  // ì‘ë‹µ ìˆ˜ì‹  í† í”½
        const payload = JSON.stringify({ name: "ì„œìœ ì •" }); // JSON ë©”ì‹œì§€

        console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl})ì— ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
        const client = mqtt.connect(brokerUrl, options);

        // ===== ì—°ê²° ì„±ê³µ ì‹œ =====
        client.on('connect', () => {
            console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);

            // ì‘ë‹µìš© í† í”½ êµ¬ë…
            client.subscribe(subTopic, (err) => {
                if (!err) {
                    console.log(`ğŸ“„ ì‘ë‹µ í† í”½ êµ¬ë… ì„±ê³µ: ${subTopic}`);

                    // JSON ë©”ì‹œì§€ ë°œí–‰
                    client.publish(pubTopic, payload);
                    console.log(`ğŸ“¤ ë©”ì‹œì§€ ë°œí–‰ ì™„ë£Œ â†’ ${pubTopic} : ${payload}`);
                } else {
                    console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
                }
            });
        });

        // ===== ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ =====
        client.on('message', (topic, message) => {
            const msg = message.toString();
            console.log(`ğŸ“© ${topic}: ${msg}`);

            // ì›¹í˜ì´ì§€ í‘œì‹œ
            const mainDiv = document.getElementById('main');
            const messageHTML = `<div class="message-item"><span>${msg}</span></div>`;
            mainDiv.innerHTML = messageHTML;

            // ThingSpeak ì „ì†¡
            const apiKey = 'YNHZUFJJ3MQHHNI4';
            const fieldValue = encodeURIComponent(msg);
            const url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=${fieldValue}`;

            fetch(url)
                .then(res => res.text())
                .then(result => console.log(`ğŸ“¤ ThingSpeak ì „ì†¡ ì™„ë£Œ: ${result}`))
                .catch(err => console.error('ThingSpeak ì „ì†¡ ì˜¤ë¥˜:', err));
        });

        // ===== ì—ëŸ¬ ì²˜ë¦¬ =====
        client.on('error', (err) => {
            console.error('ğŸš« ì—°ê²° ì˜¤ë¥˜:', err);
            client.end();
        });
    </script>
</head>
<body>
    <div id="main" style="font-family: sans-serif; margin: 20px;"></div>
</body>
</html>
